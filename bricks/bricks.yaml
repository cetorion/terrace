variant: fcos
version: 1.5.0
kernel_arguments:
  should_exist:
    - selinux=0
passwd:
  users:
    - name: ${user}
      groups: [wheel]
      ssh_authorized_keys:
        - ${key}
storage:
  files:
    - path: /etc/hostname
      mode: 0644
      overwrite: true
      contents:
        inline: ${hostname}
    - path: /etc/sudoers.d/10-wheel
      mode: 0644
      contents:
        inline: "%wheel ALL=(ALL) NOPASSWD: ALL"
    - path: /etc/selinux/config
      mode: 0644
      overwrite: true
      contents:
        inline: |
          SELINUX=disabled
          SELINUXTYPE=targeted
    - path: /etc/ssh/sshd_config.d/10-hard.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          PermitRootLogin no
          PasswordAuthentication no
          PubkeyAuthentication yes
          MaxAuthTries 3
          X11Forwarding no
    - path: /etc/yum.repos.d/kubernetes.repo
      mode: 0644
      overwrite: true
      contents:
        inline: |
          [kubernetes]
          name=Kubernetes
          baseurl=https://pkgs.k8s.io/core:/stable:/v1.35/rpm/
          enabled=1
          gpgcheck=1
          gpgkey=https://pkgs.k8s.io/core:/stable:/v1.35/rpm/repodata/repomd.xml.key
          # exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni
    - path: /opt/bootstrap.sh
      mode: 0755
      overwrite: true
      contents:
        inline: |
          #!/bin/bash
          set -e
          systemctl daemon-reload
          systemctl restart sshd
          rpm-ostree install -yA kubelet kubeadm kubectl
          systemctl enable --now kubelet
systemd:
  units:
    - name: bootstrap.service
      enabled: true
      contents: |
        [Unit]
        Description=Bootstrap
        After=default.target
        Wants=default.target
        [Service]
        Type=oneshot
        User=root
        ExecStart=/opt/bootstrap.sh
        RemainAfterExit=yes
        [Install]
        WantedBy=default.target

variant: fcos
version: 1.5.0
kernel_arguments:
  should_exist:
    - selinux=0
passwd:
  users:
    - name: ${user}
      groups: [wheel]
      ssh_authorized_keys:
        - ${key}
storage:
  links:
    - path: /etc/localtime
      target: ../usr/share/zoneinfo/${zone}
  files:
    - path: /etc/hostname
      mode: 0644
      overwrite: true
      contents:
        inline: ${hostname}
    - path: /etc/sudoers.d/10-wheel
      mode: 0644
      contents:
        inline: "%wheel ALL=(ALL) NOPASSWD: ALL"
    - path: /etc/selinux/config
      mode: 0644
      overwrite: true
      contents:
        inline: |
          SELINUX=disabled
          SELINUXTYPE=targeted
    - path: /etc/ssh/sshd_config.d/10-hard.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          Port ${port}
          PermitRootLogin no
          PasswordAuthentication no
          PubkeyAuthentication yes
          MaxAuthTries 3
          X11Forwarding no
    - path: /opt/bootstrap.sh
      mode: 0755
      overwrite: true
      contents:
        inline: |
          #!/bin/bash
          set -e
          systemctl daemon-reload
          systemctl restart sshd
systemd:
  units:
    - name: sshd.socket
      enabled: true
      dropins:
        - name: 10-override.conf
          contents: |
            [Socket]
            ListenStream=${port}
            Accept=yes
    - name: bootstrap.service
      enabled: true
      contents: |
        [Unit]
        Description=Bootstrap
        After=default.target
        Wants=default.target
        [Service]
        Type=oneshot
        User=root
        ExecStart=/opt/bootstrap.sh
        RemainAfterExit=yes
        [Install]
        WantedBy=default.target
